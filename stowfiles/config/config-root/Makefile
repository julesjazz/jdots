SCRIPTS_DIR := ./scripts

.PHONY: help asdf-update-global asdf-backup asdf-restore install-zsh-plugins pm-clean pm-install pm-sync-to-master pm-sync-from-master pm-sync-diff maintenance maint setup-new

# Default target
help:
	@echo "jdots management commands:"
	@echo ""
	@echo "ASDF Configuration"
	@echo "  asdf-update-global"
	@echo "  asdf-backup"
	@echo "  asdf-restore"
	@echo ""
	@echo "ZSH Configuration:"
	@echo "  install-zsh-plugins - Install ZSH plugins to ~/.config/zsh/plugins"
	@echo ""
	@echo "Package Manager Management:"
	@echo "  pm-clean      - Comprehensive package manager cleanup and maintenance"
	@echo "  pm-backup-clean - Clean up backup files (prompts for confirmation)"
	@echo "  pm-backup-clean-dry - Clean up backup files (dry run - no changes)"
	@echo "  pm-backup-clean-verbose - Clean up backup files (detailed output)"
	@echo "  pm-install   - Install packages from package lists"
	@echo "  pm-install-dry - Install packages (dry run - no changes)"
	@echo "  pm-install-verbose - Install packages (detailed output)"
	@echo "  pm-sync-to-master   - Sync computer package list to master"
	@echo "  pm-sync-from-master - Sync master package list to computer"
	@echo "  pm-sync-diff        - Show differences between package lists"
	@echo ""
	@echo "System Maintenance:"
	@echo "  maintenance    - (alias: maint) Full system maintenance (security + brew cleanup + stow backup)"
	@echo "  setup-new      - Complete setup for new computer (sync brew lists + install packages)"
	@echo ""
	@echo "  help           - Show this help message"
	@echo ""

# ASDF Configuration
asdf-update-global:
	@echo "ğŸ”„ Updating asdf tools to latest LTS..."
	@$(SCRIPTS_DIR)/asdf-update-lts.sh
	@echo "ğŸ“Œ Setting globally to latest installed versions..."
	@$(SCRIPTS_DIR)/asdf-set-latest.sh
	@echo "ğŸ—ƒï¸  Backing up asdf config..."
	@$(SCRIPTS_DIR)/asdf-backup.sh
	@echo "âœ… Done: asdf tools updated, set, and backed up!"
	
asdf-restore:
	@echo "â™»ï¸  Restoring asdf tools and plugins..."
	@$(SCRIPTS_DIR)/asdf-restore.sh

asdf-backup:
	@echo "ğŸ“¦ Running asdf backup..."
	@$(SCRIPTS_DIR)/asdf-backup.sh

# ZSH Configuration
install-zsh-plugins:
	@echo "ğŸ”Œ Installing ZSH plugins..."
	@$(SCRIPTS_DIR)/install-zsh-plugins.sh

# Package Manager Management
pm-clean:
	@echo "ğŸ§¹ Running comprehensive package manager cleanup..."
	@$(SCRIPTS_DIR)/pm-manager.sh clean

pm-backup-clean:
	@echo "ğŸ—‘ï¸  Running backup file cleanup..."
	@$(SCRIPTS_DIR)/pm-manager.sh backup-clean

pm-backup-clean-dry:
	@echo "ğŸ—‘ï¸  Running backup file cleanup (dry run)..."
	@$(SCRIPTS_DIR)/pm-manager.sh backup-clean --dry-run

pm-backup-clean-verbose:
	@echo "ğŸ—‘ï¸  Running backup file cleanup (verbose)..."
	@$(SCRIPTS_DIR)/pm-manager.sh backup-clean --verbose

pm-install:
	@echo "ğŸ“¦ Installing packages from package list..."
	@$(SCRIPTS_DIR)/pm-manager.sh install

pm-install-dry:
	@echo "ğŸ“¦ Installing packages from package list (dry run)..."
	@$(SCRIPTS_DIR)/pm-manager.sh install --dry-run

pm-install-verbose:
	@echo "ğŸ“¦ Installing packages from package list (verbose)..."
	@$(SCRIPTS_DIR)/pm-manager.sh install --verbose

pm-sync-to-master:
	@echo "ğŸ“¤ Syncing computer package list to master..."
	@$(SCRIPTS_DIR)/pm-manager.sh sync to-master

pm-sync-from-master:
	@echo "ğŸ“¥ Syncing master package list to computer..."
	@$(SCRIPTS_DIR)/pm-manager.sh sync from-master

pm-sync-diff:
	@echo "ğŸ” Showing differences between package lists..."
	@$(SCRIPTS_DIR)/pm-manager.sh sync diff

# System Maintenance
maintenance: maint
maint:
	@echo "ğŸ”§ Running full system maintenance..."
	@echo "ğŸ”’ Running security audit..."
	@$(SCRIPTS_DIR)/security-audit.sh
	@echo "ğŸ§¹ Running package manager cleanup..."
	@$(SCRIPTS_DIR)/pm-manager.sh clean
	@echo "ğŸ—‘ï¸  Running backup file cleanup..."
	@$(SCRIPTS_DIR)/pm-manager.sh backup-clean
	@echo "ğŸ“¦ Backing up dotfiles..."
	@if [ -d "$$HOME/jdots" ] && [ -f "$$HOME/jdots/Makefile" ]; then \
		echo "âœ… Found jdots directory, running stow-backup..."; \
		make -C ~/jdots stow-backup; \
	else \
		echo "âš ï¸  jdots directory not found at ~/jdots, skipping stow-backup"; \
	fi
	@echo "âœ… Full system maintenance complete!"
	# TODO: Fix git prompt interaction when running stow-backup from maintenance
	# Current issue: read prompt doesn't work in non-interactive make context
	# TODO: Fix pm backup-clean prompt interaction when running from maintenance
	# Current issue: read prompt doesn't work in non-interactive make context

# New Computer Setup
setup-new:
	@echo "ğŸš€ Setting up new computer..."
	@echo ""
	@echo "Step 1: Ensuring package manager is available..."
	@$(SCRIPTS_DIR)/pm-utils.sh
	@echo "âœ… Package manager detected and available"
	@echo ""
	@echo "Step 2: Installing and restoring ASDF..."
	@echo "ğŸ“¦ Installing ASDF..."
	@$(SCRIPTS_DIR)/asdf-install.sh
	@echo "ğŸ”„ Restoring ASDF packages and versions..."
	@$(SCRIPTS_DIR)/asdf-restore.sh
	@echo "âœ… ASDF setup complete"
	@echo ""
	@echo "Step 3: Installing system packages..."
	@echo "ğŸ“¥ Syncing package lists from master..."
	@$(SCRIPTS_DIR)/pm-manager.sh sync from-master
	@echo "ğŸ“¦ Installing packages..."
	@$(SCRIPTS_DIR)/pm-manager.sh install
	@echo ""
	@echo "âœ… New computer setup complete!"
	@echo "ğŸ“‹ Summary: Package manager â†’ ASDF â†’ System packages"